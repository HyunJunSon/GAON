version: "3.8"

services:
  gaon_backend:
    image: ${BACKEND_IMAGE:-asia-northeast3-docker.pkg.dev/gaon-477004/gaon-docker-hub/backend:latest}
    container_name: gaon-backend
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@localhost:5432/${DB_NAME}
      - DB_HOST=localhost
      - DB_PORT=5432
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - SECRET_KEY=${SECRET_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - FRONTEND_URL=${FRONTEND_URL}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcp-key.json
    volumes:
      - ./logs:/app/logs
      - ./gcp_service_account_key.json:/app/gcp-key.json:ro
    restart: unless-stopped
    network_mode: host

  gaon_frontend:
    image: ${FRONTEND_IMAGE:-asia-northeast3-docker.pkg.dev/gaon-477004/gaon-docker-hub/frontend:latest}
    container_name: gaon-frontend
    environment:
      - NEXT_PUBLIC_API_URL=""
    depends_on:
      - gaon_backend
    restart: unless-stopped
    network_mode: host

  nginx:
    image: nginx:alpine
    container_name: gaon-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - gaon_frontend
      - gaon_backend
    restart: unless-stopped
    network_mode: host
