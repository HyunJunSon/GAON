name: Deploy GAON Application

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
    types: [closed]

env:
  REGISTRY: ${{ secrets.GCP_REGISTRY }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REPOSITORY: ${{ secrets.GCP_REPOSITORY }}
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend_changed }}
      frontend_changed: ${{ steps.changes.outputs.frontend_changed }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check changed files
      id: changes
      run: |
        if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        else
          CHANGED_FILES=$(find backend frontend -type f 2>/dev/null || echo "all")
        fi
        
        echo "backend_changed=$(echo "$CHANGED_FILES" | grep -q '^backend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "frontend_changed=$(echo "$CHANGED_FILES" | grep -q '^frontend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  build-and-push:
    needs: check-changes
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCP
      run: gcloud auth configure-docker ${{ env.REGISTRY }}

    - name: Build and push backend image
      if: needs.check-changes.outputs.backend_changed == 'true'
      run: |
        IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest ./backend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

    - name: Build and push frontend image
      if: needs.check-changes.outputs.frontend_changed == 'true'
      run: |
        IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest ./frontend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

  deploy:
    needs: [check-changes, build-and-push]
    if: always() && needs.build-and-push.result == 'success' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Deploy to GCP VM
      run: |
        gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
          --zone=${{ secrets.GCP_ZONE }} \
          --command="
            set -e
            cd ${{ secrets.GCP_DEPLOY_PATH }}
            
            # GCP 인증
            echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
            gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
            gcloud auth configure-docker ${{ secrets.GCP_REGISTRY }}
            rm /tmp/gcp-key.json
            
            # 이미지 pull
            sudo docker pull ${{ secrets.GCP_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/backend:latest || true
            sudo docker pull ${{ secrets.GCP_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/frontend:latest || true
            
            # 컨테이너 재시작
            if [ '${{ needs.check-changes.outputs.backend_changed }}' == 'true' ]; then
              sudo docker stop gaon-backend || true
              sudo docker rm gaon-backend || true
              sudo docker run -d --name gaon-backend --network ${{ secrets.GCP_NETWORK }} \
                -v ${{ secrets.GCP_DEPLOY_PATH }}/logs:/app/logs \
                -v ${{ secrets.GCP_DEPLOY_PATH }}/gcp_service_account_key.json:/app/gcp_service_account_key.json:ro \
                ${{ secrets.GCP_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/backend:latest
            fi
            
            if [ '${{ needs.check-changes.outputs.frontend_changed }}' == 'true' ]; then
              sudo docker stop gaon-frontend || true
              sudo docker rm gaon-frontend || true
              sudo docker run -d --name gaon-frontend --network ${{ secrets.GCP_NETWORK }} \
                ${{ secrets.GCP_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/frontend:latest
            fi
            
            # Nginx 재시작
            sudo docker restart gaon-nginx
            
            # 헬스체크
            sleep 10
            curl -f https://xn--o39a190c.site/api/health || exit 1
            
            echo '✅ Deployment completed!'
          "
