name: Deploy GAON Application

on:
  push:
    branches: [ "main", "develop" ]

env:
  REGISTRY: ${{ secrets.GCP_REGISTRY }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REPOSITORY: ${{ secrets.GCP_REPOSITORY }}
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend_changed }}
      frontend_changed: ${{ steps.changes.outputs.frontend_changed }}
      migration_changed: ${{ steps.changes.outputs.migration_changed }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check changed files
      id: changes
      run: |
        if git rev-parse --verify HEAD~2 >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only HEAD~2 HEAD)
        else
          echo "HEAD~2 not available, treating all files as changed"
          CHANGED_FILES=$(find . -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.tsx" -o -name "*.json" -o -name "Dockerfile*" | grep -E "(backend/|frontend/)" | head -10)
        fi
        
        echo "backend_changed=$(echo "$CHANGED_FILES" | grep -q '^backend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "frontend_changed=$(echo "$CHANGED_FILES" | grep -q '^frontend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "migration_changed=$(echo "$CHANGED_FILES" | grep -q '^backend/alembic/versions/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        
        echo "Changed files: $CHANGED_FILES"

  build-backend:
    needs: check-changes
    if: needs.check-changes.outputs.backend_changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCP
      run: gcloud auth configure-docker ${{ secrets.GCP_REGISTRY }}

    - name: Build and push backend image
      run: |
        IMAGE_TAG=${{ secrets.GCP_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/${{ env.BACKEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest ./backend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

  build-frontend:
    needs: check-changes
    if: needs.check-changes.outputs.frontend_changed == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCP
      run: gcloud auth configure-docker ${{ secrets.GCP_REGISTRY }}

    - name: Build and push frontend image
      run: |
        IMAGE_TAG=${{ secrets.GCP_REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/${{ env.FRONTEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest ./frontend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

  deploy:
    needs: [check-changes, build-backend, build-frontend]
    if: always() && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Setup SSH key from secrets
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/google_compute_engine
        chmod 600 ~/.ssh/google_compute_engine
        echo "${{ secrets.GCP_SSH_PUB_KEY }}" > ~/.ssh/google_compute_engine.pub
        chmod 644 ~/.ssh/google_compute_engine.pub

    - name: Create deployment script
      env:
        REGISTRY: ${{ secrets.GCP_REGISTRY }}
        PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        REPOSITORY: ${{ secrets.GCP_REPOSITORY }}
        DEPLOY_PATH: ${{ secrets.GCP_DEPLOY_PATH }}
        MIGRATION_CHANGED: ${{ needs.check-changes.outputs.migration_changed }}
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      run: |
        cat > deploy.sh << 'EOFSCRIPT'
        set -e
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export REGISTRY="${REGISTRY}"
        export PROJECT_ID="${PROJECT_ID}"
        export REPOSITORY="${REPOSITORY}"
        
        cd ${DEPLOY_PATH}
        
        # ë¡œê·¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
        sudo mkdir -p logs
        sudo chown -R 1000:1000 logs
        
        # GCP ì¸ì¦
        echo "${GCP_SA_KEY}" > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud auth configure-docker $REGISTRY
        rm /tmp/gcp-key.json
        
        # ìµœì‹  ì´ë¯¸ì§€ pull
        sudo docker pull ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/backend:latest || echo "Backend ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©"
        sudo docker pull ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/frontend:latest || echo "Frontend ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©"
        
        # ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ íƒœê·¸ ìƒì„±
        sudo docker tag ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/backend:latest gaon:back-server
        sudo docker tag ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/frontend:latest gaon:front-server
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        export BACKEND_IMAGE=gaon:back-server
        export FRONTEND_IMAGE=gaon:front-server
        
        # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€ ë°±ì—… (ë¡¤ë°±ìš©)
        CURRENT_BACKEND=$(sudo docker inspect gaon-backend --format='{{.Config.Image}}' 2>/dev/null || echo "")
        CURRENT_FRONTEND=$(sudo docker inspect gaon-frontend --format='{{.Config.Image}}' 2>/dev/null || echo "")
        
        # ë¡¤ë°± í•¨ìˆ˜
        rollback() {
          echo "ğŸš¨ Error detected! Rolling back..."
          if [ ! -z "$CURRENT_BACKEND" ] && [ ! -z "$CURRENT_FRONTEND" ]; then
            export BACKEND_IMAGE=$CURRENT_BACKEND
            export FRONTEND_IMAGE=$CURRENT_FRONTEND
            sudo docker-compose -f docker-compose.prod.yml up -d --no-deps gaon-backend
            sudo docker-compose -f docker-compose.prod.yml up -d --no-deps gaon-frontend
            sudo docker-compose -f docker-compose.prod.yml up -d --no-deps gaon-nginx
            echo "âœ… Rollback completed!"
          fi
          exit 1
        }
        
        # ì—ëŸ¬ ì‹œ ë¡¤ë°± ì‹¤í–‰
        trap rollback ERR
        
        # ë¡¤ë§ ì—…ë°ì´íŠ¸ (ë¬´ì¤‘ë‹¨ ë°°í¬)
        echo "ğŸš€ Starting rolling update..."
        
        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ê°•ì œ ì •ë¦¬ (PostgreSQL ì œì™¸)
        echo "ğŸ§¹ Cleaning up existing containers (preserving PostgreSQL)..."
        sudo docker rm -f gaon-backend gaon-frontend gaon-nginx 2>/dev/null || true
        sudo docker-compose -f docker-compose.prod.yml down --remove-orphans || true
        sudo docker system prune -f || true
        
        echo "â³ Waiting for cleanup to complete..."
        sleep 5
        
        # PostgreSQLì´ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ ì‹œì‘
        if ! sudo docker ps | grep -q gaon-postgres; then
          echo "ğŸ—„ï¸ Starting PostgreSQL database..."
          sudo docker-compose -f docker-compose-db.yml up -d
          sleep 10
        fi
        
        # GCP ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ í™•ì¸ ë° ìƒì„±
        if [ ! -f "${DEPLOY_PATH}/gcp_service_account_key.json" ]; then
          echo "ğŸ”‘ Creating GCP service account key file..."
          echo "${GCP_SA_KEY}" > ${DEPLOY_PATH}/gcp_service_account_key.json
          chmod 600 ${DEPLOY_PATH}/gcp_service_account_key.json
        fi
        
        # ìƒˆë¡œ ì‹œì‘
        sudo docker-compose -f docker-compose.prod.yml up -d || rollback
        echo "â³ Waiting for services to start..."
        sleep 20
        
        # DB ì—°ê²° í™•ì¸
        echo "ğŸ—„ï¸ Checking database connection..."
        for i in {1..30}; do
          if sudo docker exec gaon-postgres pg_isready -U gaon_admin -d gaon; then
            echo "âœ… Database is ready!"
            break
          fi
          echo "â³ Waiting for database... ($i/30)"
          sleep 2
        done
        
        # DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (ë§ˆì´ê·¸ë ˆì´ì…˜ ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œ)
        if [ "${MIGRATION_CHANGED}" == "true" ]; then
          echo "ğŸ”„ Applying database migrations..."
          sudo docker exec -w /app gaon-backend alembic upgrade head || rollback
          echo "âœ… Database migrations applied successfully!"
        fi
        
        # í—¬ìŠ¤ì²´í¬
        if ! curl -f https://xn--o39a190c.site/api/health; then
          echo "âŒ Backend health check failed!"
          rollback
        fi
        
        # ì •ë¦¬
        sudo docker image prune -f
        
        echo "âœ… Deployment completed successfully!"
        EOFSCRIPT
        
        # Export variables for script
        export REGISTRY="$REGISTRY"
        export PROJECT_ID="$PROJECT_ID"
        export REPOSITORY="$REPOSITORY"
        export DEPLOY_PATH="$DEPLOY_PATH"
        export MIGRATION_CHANGED="$MIGRATION_CHANGED"
        export GCP_SA_KEY="$GCP_SA_KEY"
        
        # Replace variables in script
        envsubst < deploy.sh > deploy_final.sh
        mv deploy_final.sh deploy.sh
        chmod +x deploy.sh

    - name: Debug secrets
      run: |
        echo "VM_NAME length: ${#VM_NAME}"
        echo "ZONE length: ${#ZONE}"
      env:
        VM_NAME: ${{ secrets.GCP_VM_NAME }}
        ZONE: ${{ secrets.GCP_ZONE }}

    - name: Get VM external IP
      id: get-ip
      run: |
        VM_IP=$(gcloud compute instances describe ${{ secrets.GCP_VM_NAME }} \
          --zone=${{ secrets.GCP_ZONE }} \
          --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
        echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT
        echo "VM IP: $VM_IP"

    - name: Copy and execute deployment script
      run: |
        scp -i ~/.ssh/google_compute_engine \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          deploy.sh hyunjunson@${{ steps.get-ip.outputs.vm_ip }}:/tmp/deploy.sh
        
        ssh -i ~/.ssh/google_compute_engine \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          hyunjunson@${{ steps.get-ip.outputs.vm_ip }} \
          "bash /tmp/deploy.sh && rm /tmp/deploy.sh"
