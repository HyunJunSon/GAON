// app/api/analysis/[conversationId]/route.ts
import { NextResponse } from 'next/server';

/**
 * 간단 목업: 같은 conversationId로 여러 번 조회하면
 * 1~2회는 queued/processing, 이후 ready로 응답
 */
const hitMap = new Map<string, number>();

export async function GET(
  _req: Request,
  { params }: { params: Promise<{ conversationId: string }> }
) {
  const { conversationId } = await params;
  const hits = (hitMap.get(conversationId) || 0) + 1;
  hitMap.set(conversationId, hits);

  if (hits === 1) {
    return NextResponse.json({
      conversationId,
      status: 'queued',
      updatedAt: new Date().toISOString(),
    });
  }
  if (hits === 2) {
    return NextResponse.json({
      conversationId,
      status: 'processing',
      updatedAt: new Date().toISOString(),
    });
  }

  // ready 응답 (샘플 데이터)
  // return NextResponse.json({
  //   conversationId,
  //   status: 'ready',
  //   updatedAt: new Date().toISOString(),
  //   summary: {
  //     bullets: [
  //       '시험 준비 일정에 대한 합의 필요',
  //       '부모-자녀 간 신뢰/소통 이슈 발견',
  //       '휴식 시간과 학습 계획 조율 요구',
  //     ],
  //   },
  //   emotion: {
  //     series: [
  //       { label: '긍정', value: 62 },
  //       { label: '중립', value: 22 },
  //       { label: '부정', value: 16 },
  //     ],
  //   },
  //   dialog: {
  //     raw: `엄마: 지금 시험기간 아니야?\n아들: 잠깐 쉬는 거야...\n아빠: 잠깐이 하루 종일이냐?...`,
  //   },
  // });
  return NextResponse.json({
    conversationId,
    status: 'ready',
    created_at: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    // 사용자/상대방 말뭉치 통계 + 비교 문구
    statistics: {"user": {
      "top_words": ["철자", "오류나", "이상한", "없습니다", "자연스러운"], 
      "word_count": 51, 
      "unique_words": 41, 
      "avg_sentence_length": 12.8
    }, "others": {"word_count": 24, "unique_words": 24, "avg_sentence_length": 8.0}, 
    "comparison": "사용자는 상대방보다 말을 많이 함, 사용자는 긴 문장을 선호"},
    // (화자 ID 키)화자에 대한 말투/성향 분석
    style_analysis: {"1": {
      "주요_관심사": "대화의 주제가 상대방의 고민과 가족 관계인 만큼, 사용자는 소통과 관계 형성, 타인의 감정을 이해하는 것에 높은 관심을 가지고 있는 것으로 보입니다.", 
      "대화_비교_분석": "상대방에 비해 사용자는 대화에서 주도적인 역할을 하고 있으며, 정보 제공보다는 감정적 지지를 통한 대화를 이끌어가는 경향이 있습니다. 또한, 평균 문장 길이가 상대방보다 긴 반면, 상대방보다 더 많은 단어를 사용하며 세밀한 대화를 지향하고 있습니다.", 
      "말투_특징_분석": "사용자는 주로 존댓말을 사용하며, 자연스러운 문장 구성을 통해 부드러운 대화 분위기를 유지합니다. 문장은 대체로 간결하지만 상대방의 상황에 따라 세심하게 대응하는 특징이 있습니다.", 
      "대화_성향_및_감정_표현": "긍정적인 성향을 보이며, 상대방의 고민이나 어려움에 대해 공감하고 격려하는 방식으로 감정을 표현합니다. 구체적인 질문을 통해 상대방의 이야기를 이끌어내는 모습이 드러납니다."
    }},
    // 긴 멀티라인 리포트
    summary: `==================================================
      📊 대화 분석 종합 리포트
      ==================================================

      [분석 대상] 사용자 ID: 1  
      [대화 규모] 전체 7회 발화 (사용자: 4회, 상대방: 3회)

      --------------------------------------------------
      🎯 말하기 점수: 0.91/1.00
      --------------------------------------------------

      📈 통계 분석
      • 사용자 총 단어 수: 51개  
      • 사용자 평균 문장 길이: 12.8단어  
      • 사용자 고유 단어 수: 41개  
      • 사용자 자주 사용한 단어: 철자, 오류나, 이상한, 없습니다, 자연스러운  

      • 상대방 총 단어 수: 24개  
      • 상대방 평균 문장 길이: 8.0단어  

      • 비교 분석: 사용자는 상대방보다 말을 많이 함, 사용자는 긴 문장을 선호  

      **🤖 AI 해석:**  
      사용자는 대화에서 적극적으로 참여하며 상대방보다 더 많은 단어를 사용했습니다. 평균 문장 길이에서도 상대방보다 긴 문장을 사용하여, 보다 심도 있는 대화를 나누고 있다는 것을 나타냅니다. 이는 사용자가 정보를 전달하는 것뿐만 아니라, 상대방의 이야기를 깊이 이해하고자 하는 의지를 내포하고 있습니다.

      🗣️ 말투 특징 분석  
      사용자는 주로 존댓말을 사용하며, 자연스러운 문장 구성을 통해 부드러운 대화 분위기를 유지합니다. 질문을 통해 상대방의 생각을 끌어내는 방식이 돋보이며, 대화의 흐름에 맞추어 상대방의 반응에 세심하게 반응하는 특징이 있습니다.

      **🤖 AI 심층 분석:**  
      "요즘 고민 있어?"와 같은 질문을 통해 상대방의 감정 상태를 확인하고, "아... 그건 힘들겠다."라는 공감 표현으로 상대방의 마음을 여는 데에 능숙합니다. 이는 사용자가 상대방의 감정을 중요시하고, 그에 맞춰 대화를 조율할 줄 아는 능력을 보여줍니다.

      💬 대화 성향 및 감정 표현  
      사용자는 긍정적인 성향을 보이며, 상대방의 고민에 대해 공감하고 격려하는 방식으로 감정을 표현합니다. 구체적인 질문을 통해 상대방이 느끼는 어려움을 잘 이해하고, 이를 통한 심화된 대화를 나누려고 노력합니다. 

      **🤖 AI 심층 분석:**  
      "부모님한테 솔직하게 얘기해봤어?"와 같은 질문은 상대방이 자신의 감정을 표현하게끔 유도하며, 그에 대한 긍정적인 피드백을 주려고하는 모습이 나타나 있습니다. 이는 대화의 깊이를 더하고 상대방의 상황을 진정으로 이해하려는 태도를 보여줍니다.

      🎯 주요 관심사  
      대화의 주제가 상대방의 고민과 가족 관계인 만큼, 사용자는 소통과 관계 형성, 타인의 감정을 이해하는 것에 높은 관심을 두고 있는 것으로 판단됩니다. 이러한 관심사는 그가 사람들과의 관계에서 긍정적인 역할을 하고자 하는 욕구에서 비롯된 것으로 보입니다.

      📊 상대방과의 비교  
      상대방에 비해 사용자는 대화에서 주도적인 역할을 하고 있으며, 정보 제공보다는 감정적 지지를 통한 대화를 이끌어가는 경향이 있습니다. 평균 문장 길이가 상대방보다 긴 반면, 상대에게 더 많은 단어를 사용하여 세밀한 대화를 지향하고 있습니다. 이는 사용자가 대화의 질을 높이는 데 기여하고 있음을 나타냅니다.

      **🤖 AI 종합 평가:**  
      **강점:**  
      1. 상대방의 감정에 공감하고 격려하는 능력을 통해 신뢰를 구축하는 데 뛰어난 점.  
      2. 질문을 통해 대화의 깊이를 더하고, 상대방이 솔직히 이야기할 수 있게 유도하는 점.  

      **개선점:**  
      1. 때때로 대화의 주제를 상대방에게 좀 더 명확하게 전달하는 것이 필요할 수 있음.  

      **추천 사항:**  
      1. 대화에서 다소 삐죽삐죽한 형식의 언어를 피하고, 간결하면서도 핵심적인 표현을 갈고닦으면 소통의 효과가 더욱 증대될 수 있을 것임.  

      ==================================================

      ==================================================
      🔍 QA 품질 평가
      ==================================================

      [신뢰도 점수] 0.90/1.00

      [평가 근거]
        대화 분석이 통계 데이터와 잘 일치하며, 스타일 분석이 사용자 발화를 효과적으로 반영하고 있음. 요약 또한 대화 내용을 명확하게 요약하고 있으며, 전반적으로 높은 신뢰성을 보여줌.

      ==================================================
    `,
    // 말하기 점수
    score: 0.91,
    // 코멘트 문자열
    feedback: ``,
    // 신뢰도 점수
    confidence_score: 0.86,
    dialog: {
      raw: `엄마: 지금 시험기간 아니야?\n아들: 잠깐 쉬는 거야...\n아빠: 잠깐이 하루 종일이냐?...`,
    },
  })
}