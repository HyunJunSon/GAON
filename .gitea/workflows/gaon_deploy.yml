name: Deploy GAON Application

on:
  push:
    branches: [ "main", "develop" ]

env:
  REGISTRY: asia-northeast3-docker.pkg.dev
  PROJECT_ID: gaon-477004
  REPOSITORY: gaon-docker-hub
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

jobs:
  check-changes:
    runs-on: self-hosted
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend_changed }}
      frontend_changed: ${{ steps.changes.outputs.frontend_changed }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
    
    - name: Check changed files
      id: changes
      run: |
        echo "backend_changed=$(git diff --name-only HEAD~1 HEAD | grep -q '^backend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "frontend_changed=$(git diff --name-only HEAD~1 HEAD | grep -q '^frontend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  build-backend:
    needs: check-changes
    if: needs.check-changes.outputs.backend_changed == 'true'
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud auth configure-docker ${{ env.REGISTRY }}
        rm /tmp/gcp-key.json

    - name: Build and push backend image
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest -t gaon:back-server ./backend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

  build-frontend:
    needs: check-changes
    if: needs.check-changes.outputs.frontend_changed == 'true'
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud auth configure-docker ${{ env.REGISTRY }}
        rm /tmp/gcp-key.json

    - name: Build and push frontend image
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest -t gaon:front-server ./frontend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

  deploy:
    needs: [check-changes, build-backend, build-frontend]
    if: always() && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: self-hosted
    
    steps:
    - name: Deploy to OCI Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USERNAME }}
        key: ${{ secrets.OCI_SSH_KEY }}
        port: ${{ secrets.OCI_PORT }}
        script: |
          set -e
          
          cd /home/ubuntu/gaon
          
          # ë¡œê·¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
          sudo mkdir -p logs
          sudo chown -R 1000:1000 logs
          
          # ìµœì‹  ì´ë¯¸ì§€ pull (Docker ì¸ì¦ì€ ì´ë¯¸ ë˜ì–´ ìˆìŒ)
          docker pull asia-northeast3-docker.pkg.dev/gaon-477004/gaon-docker-hub/backend:latest || echo "Backend ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©"
          docker pull asia-northeast3-docker.pkg.dev/gaon-477004/gaon-docker-hub/frontend:latest || echo "Frontend ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©"
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export BACKEND_IMAGE=gaon:back-server
          export FRONTEND_IMAGE=gaon:front-server
          
          # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€ ë°±ì—… (ë¡¤ë°±ìš©)
          CURRENT_BACKEND=$(docker inspect gaon-backend --format='{{.Config.Image}}' 2>/dev/null || echo "")
          CURRENT_FRONTEND=$(docker inspect gaon-frontend --format='{{.Config.Image}}' 2>/dev/null || echo "")
          
          # ë¡¤ë°± í•¨ìˆ˜
          rollback() {
            echo "ğŸš¨ Error detected! Rolling back..."
            if [ ! -z "$CURRENT_BACKEND" ] && [ ! -z "$CURRENT_FRONTEND" ]; then
              export BACKEND_IMAGE=$CURRENT_BACKEND
              export FRONTEND_IMAGE=$CURRENT_FRONTEND
              docker-compose -f docker-compose.prod.yml up -d --no-deps gaon_backend
              docker-compose -f docker-compose.prod.yml up -d --no-deps gaon_frontend
              docker-compose -f docker-compose.prod.yml up -d --no-deps gaon_nginx
              echo "âœ… Rollback completed!"
            fi
            exit 1
          }
          
          # ì—ëŸ¬ ì‹œ ë¡¤ë°± ì‹¤í–‰
          trap rollback ERR
          
          # ë¡¤ë§ ì—…ë°ì´íŠ¸ (ë¬´ì¤‘ë‹¨ ë°°í¬)
          echo "ğŸš€ Starting rolling update..."
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì™„ì „ ì •ë¦¬ (ContainerConfig ì—ëŸ¬ ë°©ì§€)
          docker-compose -f docker-compose.prod.yml down --remove-orphans || true
          docker system prune -f || true
          
          # ìƒˆë¡œ ì‹œì‘
          docker-compose -f docker-compose.prod.yml up -d || rollback
          echo "â³ Waiting for services to start..."
          sleep 20
          
          # í—¬ìŠ¤ì²´í¬
          if ! curl -f http://localhost:8000/health; then
            echo "âŒ Backend health check failed!"
            rollback
          fi
          
          # ì •ë¦¬
          docker image prune -f
          
          echo "âœ… Deployment completed successfully!"
