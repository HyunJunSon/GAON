name: Deploy GAON Application

on:
  push:
    branches: [ "main", "develop", "feature/#39_CICD_pipeline" ]  # TODO: í…ŒìŠ¤íŠ¸ í›„ feature/#39_CICD_pipeline ì œê±°

env:
  REGISTRY: asia-northeast3-docker.pkg.dev
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REPOSITORY: gaon-docker-hub
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

jobs:
  check-changes:
    runs-on: self-hosted
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend_changed }}
      frontend_changed: ${{ steps.changes.outputs.frontend_changed }}
      migration_changed: ${{ steps.changes.outputs.migration_changed }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
    
    - name: Check changed files
      id: changes
      run: |
        # ì•ˆì „í•œ ë³€ê²½ì‚¬í•­ ê°ì§€
        if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        else
          CHANGED_FILES=$(git show --name-only --format="" HEAD)
        fi
        
        echo "backend_changed=$(echo "$CHANGED_FILES" | grep -q '^backend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "frontend_changed=$(echo "$CHANGED_FILES" | grep -q '^frontend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "migration_changed=$(echo "$CHANGED_FILES" | grep -q '^backend/alembic/versions/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  build-backend:
    needs: check-changes
    if: needs.check-changes.outputs.backend_changed == 'true'
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud auth configure-docker ${{ env.REGISTRY }}
        rm /tmp/gcp-key.json

    - name: Build and push backend image
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.BACKEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest -t gaon:back-server ./backend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

  build-frontend:
    needs: check-changes
    if: needs.check-changes.outputs.frontend_changed == 'true'
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud auth configure-docker ${{ env.REGISTRY }}
        rm /tmp/gcp-key.json

    - name: Build and push frontend image
      run: |
        export PATH=$PATH:/home/ubuntu/google-cloud-sdk/bin
        IMAGE_TAG=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.FRONTEND_IMAGE }}
        docker build -t ${IMAGE_TAG}:${{ github.sha }} -t ${IMAGE_TAG}:latest -t gaon:front-server ./frontend
        docker push ${IMAGE_TAG}:${{ github.sha }}
        docker push ${IMAGE_TAG}:latest

  deploy:
    needs: [check-changes, build-backend, build-frontend]
    if: always() && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/#39_CICD_pipeline')
    runs-on: self-hosted
    
    steps:
    - name: Deploy to OCI Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USERNAME }}
        key: ${{ secrets.OCI_SSH_KEY }}
        port: ${{ secrets.OCI_PORT }}
        script: |
          set -e
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export REGISTRY="${{ env.REGISTRY }}"
          export PROJECT_ID="${{ env.PROJECT_ID }}"
          export REPOSITORY="${{ env.REPOSITORY }}"
          
          cd /home/ubuntu/gaon
          
          # ë¡œê·¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
          sudo mkdir -p logs
          sudo chown -R 1000:1000 logs
          
          # ìµœì‹  ì´ë¯¸ì§€ pull (Docker ì¸ì¦ì€ ì´ë¯¸ ë˜ì–´ ìˆìŒ)
          docker pull ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/backend:latest || echo "Backend ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©"
          docker pull ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/frontend:latest || echo "Frontend ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ë¡œì»¬ ì´ë¯¸ì§€ ì‚¬ìš©"
          
          # ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ íƒœê·¸ ìƒì„±
          docker tag ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/backend:latest gaon:back-server
          docker tag ${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/frontend:latest gaon:front-server
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export BACKEND_IMAGE=gaon:back-server
          export FRONTEND_IMAGE=gaon:front-server
          
          # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€ ë°±ì—… (ë¡¤ë°±ìš©)
          CURRENT_BACKEND=$(docker inspect gaon-backend --format='{{.Config.Image}}' 2>/dev/null || echo "")
          CURRENT_FRONTEND=$(docker inspect gaon-frontend --format='{{.Config.Image}}' 2>/dev/null || echo "")
          
          # ë¡¤ë°± í•¨ìˆ˜
          rollback() {
            echo "ğŸš¨ Error detected! Rolling back..."
            if [ ! -z "$CURRENT_BACKEND" ] && [ ! -z "$CURRENT_FRONTEND" ]; then
              export BACKEND_IMAGE=$CURRENT_BACKEND
              export FRONTEND_IMAGE=$CURRENT_FRONTEND
              docker-compose -f docker-compose.prod.yml up -d --no-deps gaon_backend
              docker-compose -f docker-compose.prod.yml up -d --no-deps gaon_frontend
              docker-compose -f docker-compose.prod.yml up -d --no-deps gaon_nginx
              echo "âœ… Rollback completed!"
            fi
            exit 1
          }
          
          # ì—ëŸ¬ ì‹œ ë¡¤ë°± ì‹¤í–‰
          trap rollback ERR
          
          # ë¡¤ë§ ì—…ë°ì´íŠ¸ (ë¬´ì¤‘ë‹¨ ë°°í¬)
          echo "ğŸš€ Starting rolling update..."
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ê°•ì œ ì •ë¦¬ (ì»¨í…Œì´ë„ˆ ì´ë¦„ ì¶©ëŒ ë°©ì§€)
          echo "ğŸ§¹ Cleaning up existing containers..."
          docker rm -f gaon-backend gaon-frontend gaon-nginx gaon-postgres 2>/dev/null || true
          docker rm -f $(docker ps -aq --filter "name=gaon") 2>/dev/null || true
          docker-compose -f docker-compose.prod.yml down --remove-orphans || true
          docker system prune -f || true
          
          echo "â³ Waiting for cleanup to complete..."
          sleep 5
          
          # ìƒˆë¡œ ì‹œì‘
          docker-compose -f docker-compose.prod.yml up -d || rollback
          echo "â³ Waiting for services..."
          sleep 30
          
          # DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
          if [ "${{ needs.check-changes.outputs.migration_changed }}" == "true" ]; then
            echo "ğŸ”„ Applying database migrations..."
            docker cp /home/ubuntu/gaon/alembic.ini gaon-backend:/app/alembic.ini
            
            # DB ì¤€ë¹„ ëŒ€ê¸° (30ì´ˆ)
            sleep 30
            
            docker exec gaon-backend alembic upgrade head || rollback
            echo "âœ… Database migrations applied!"
          fi
          
          # í—¬ìŠ¤ì²´í¬
          if ! curl -f http://localhost:8000/health; then
            echo "âŒ Backend health check failed!"
            rollback
          fi
          
          # ì •ë¦¬
          docker image prune -f
          
          echo "âœ… Deployment completed successfully!"
