name: create-daily-log
on:
  schedule:
    # UTC ê¸°ì¤€: Sunâ€“Thu 23:30 â†’ KST ê¸°ì¤€: Monâ€“Fri 08:30
    - cron: "30 23 * * 0-4"
  workflow_dispatch:

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Create Daily Log issue
        env:
          GITEA_BASE: http://dev.wyhil.com:43000     # âœ… ì‹¤ì œ Gitea ì£¼ì†Œë¡œ ë³€ê²½
          REPO: SG-OHA-2025-TEAM-04/GAON             # âœ… ì‹¤ì œ ì¡°ì§/ë ˆí¬ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
          TOKEN: ${{ secrets.DAILY_LOG_TOKEN }}      # âœ… Secrets ì´ë¦„ ë§ì¶”ê¸°
        run: |
          set -e
          TODAY_KST=$(TZ=Asia/Seoul date +%m.%d)    # ì˜ˆ: 10.31
          ISO_WEEK=$(TZ=Asia/Seoul date +%V)        # ì£¼ì°¨ ê³„ì‚°
          TITLE="${TODAY_KST} Daily Log"

          # ---- ì¤‘ë³µ ìƒì„± ë°©ì§€ ----
          QUERY=$(python3 - <<PY
import urllib.parse as u; print(u.quote("${TITLE}"))
PY
)
          EXISTS=$(curl -s -H "Authorization: token $TOKEN" \
            "$GITEA_BASE/api/v1/repos/$REPO/issues/search?q=${QUERY}&limit=1" \
            | jq -r '.total_count // .issues|length // 0')
          if [ "${EXISTS}" != "0" ]; then
            echo "âœ… '${TITLE}' already exists. Skip creating duplicate."
            exit 0
          fi

          # ---- ì´ìŠˆ ìƒì„± ìš”ì²­ (í…œí”Œë¦¿ ì ìš©) ----
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg body "" \
            --argjson labels '["type:daily-log"]' \
            --argjson assignees '["edgar_kim","ahnseoyeon","sojy001","zorba"]' \
            '{title:$title, body:$body, labels:$labels, assignees:$assignees}')

          curl -s -X POST "$GITEA_BASE/api/v1/repos/$REPO/issues" \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

          echo "ğŸ‰ Created '${TITLE}' successfully!"